name: Build and Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-2022]
      fail-fast: false

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      # 2️⃣ Setup Python + Conan
      - name: Setup Python and Conan
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          pip install conan

      # 3️⃣ Install build tools
      - name: Install build tools (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      # 4️⃣ Windows build tools (MSVC)
      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-2022'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 5️⃣ Conan install dependencies
      - name: Conan install dependencies
        run: |
          conan install . --build=missing -s build_type=Release -s compiler.cppstd=20

      # 6️⃣ Configure and build with CMake
      - name: CMake configure and build
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      # 7️⃣ Run tests
      - name: Run tests
        run: |
          cmake --build build --target test || true

      # 8️⃣ Upload artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: build
