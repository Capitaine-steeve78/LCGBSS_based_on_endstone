name: Build Endstone

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Setup Conan
      run: |
        python -m pip install --upgrade pip
        pip install conan==2.6.2

    - name: Configure Conan profile
      if: matrix.os == 'ubuntu-latest'
      run: |
        conan profile new default --detect --force
        conan profile update settings.compiler.cppstd=20 default
        conan profile update settings.compiler.libcxx=libstdc++11 default
      if: matrix.os == 'windows-latest'
      run: |
        conan profile new default --detect --force
        conan profile update settings.compiler.cppstd=20 default

    - name: Install dependencies
      run: |
        conan install . --build=missing -s build_type=Release

    - name: Configure CMake
      run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Run Tests
      run: ctest --output-on-failure --test-dir build
